name       : mariadb
version    : 10.3.13
release    : 14
source     :
    - https://github.com/MariaDB/server/archive/mariadb-10.3.13.tar.gz : b83049a25447c5249d2bd8aa93f5c6426993fe4c68cea0389b5c7d0a082b1f92
    - git|https://github.com/MariaDB/mariadb-connector-c.git : 2c5aebb3bc724c1663c481ba2fedde00ab494fa4
license    :
    - BSD-3-Clause
    - GPL-2.0-or-later
    - LGPL-2.1-or-later
component  :
    - database
    - bench : database
    - embedded : database
    - libs : programming.library
    - server : database
    - test : database
summary    :
    - MariaDB server is a community developed fork of MySQL server.
    - bench : |
        This package provides MariaDB benchmark data
    - embedded : |
        This package provides an embeddable MariaDB server.
    - libs : |
        This package provides the MariaDB client libraries
    - server : |
        This package provides the MariaDB server component
    - test : |
        This package provides the test components for MariaDB
    - docs : |
        This package provides MariaDB documentation
description: |
    MariaDB server is a community developed fork of MySQL server. Started by
    core members of the original MySQL team, MariaDB actively works with
    outside developers to deliver the most featureful, stable, and sanely
    licensed open SQL server in the industry.
builddeps  :
    - pkgconfig(jemalloc)
    - pkgconfig(krb5-gssapi)
    - pkgconfig(libarchive)
    - pkgconfig(libevent)
    - pkgconfig(libpcre)
    - pkgconfig(liblz4)
    - pkgconfig(liblzma)
    - bzip2-devel
    - libaio-devel
    - lzo-devel
patterns   :
    - bench :
        - /usr/share/sql-bench
    - devel :
        - /usr/share/pkgconfig
    - docs :
        - /usr/share/man
        - /usr/share/doc
    - libs :
        - /usr/lib64/lib*.so*
        - /usr/lib64/mysql/plugin/dialog.so
        - /usr/lib64/mysql/plugin/mysql_clear_password.so
    - server :
        - /etc/mysql/my.cnf.d/enable_encryption.preset
        - /etc/mysql/my.cnf.d/server.cnf
        - /etc/mysql/my.cnf.d/tokudb.cnf
        - /usr/bin/mariabackup
        - /usr/sbin/mysqld
        - /usr/bin/aria*
        - /usr/bin/inno*
        - /usr/bin/mysql_install_db
        - /usr/bin/myisam*
        - /usr/bin/mysqld*
        - /usr/bin/mysql_*
        - /usr/bin/mysqlhotcopy
        - /usr/bin/perror
        - /usr/bin/resolve*
        - /usr/bin/tokuft*
        - /usr/lib64/systemd
        - /usr/lib64/sysusers.d
        - /usr/lib64/tmpfiles.d
        - /usr/lib64/mysql/plugin
        - /usr/lib64/libmysqld.so*
        - /usr/share/groonga*
        - /usr/share/mysql/*.sql
        - /usr/share/mysql/my-*.cnf
        - /usr/share/mysql/mroonga
        - /usr/share/mysql/systemd
    - test :
        - /usr/bin/mysqltest
        - /usr/share/mysql/test
    - embedded :
        - /usr/bin/*embedded*
    - main :
        - /usr/bin/mysqldump
        - /usr/bin/mysql_find_rows
        - /usr/bin/mysql_plugin
        - /usr/bin/mysql_waitpid
rundeps    :
    - server : mariadb
    - devel :
        - mariadb-libs
        - mariadb-server
setup      : |
    cp -r $sources/mariadb-connector-c.git/* libmariadb/

    %patch -p1 < $pkgfiles/0001-support-files-Add-Solus-integration.patch
    %patch -p1 < $pkgfiles/0002-storage-No-nope-and-even-more-nope.patch

    %cmake . \
    -DPLUGIN_AUTH_GSSAPI:STRING=NO  \
    -WITH_SYSTEMD=yes \
    -DSECURITY_HARDENED=ON \
    -DBUILD_CONFIG=mysql_release \
    -DWITH_JEMALLOC=yes \
    -DWITH_PCRE=system \
    -DWITH_READLINE=ON \
    -DWITH_SSL=system \
    -DWITH_ZLIB=system \
    -DENABLED_LOCAL_INFILE=ON \
    -DWITH_EMBEDDED_SERVER=ON \
    -DINSTALL_LIBDIR="lib%LIBSUFFIX%" \
    -DINSTALL_SYSTEMD_UNITDIR="%libdir%/systemd/system" \
    -DINSTALL_MANDIR=share/man \
    -DINSTALL_DOCDIR=share/doc/mariadb-${version} \
    -DINSTALL_DOCREADMEDIR=share/doc/mariadb-${version} \
    -DINSTALL_MYSQLSHAREDIR=share/mysql \
    -DINSTALL_MYSQLTESTDIR=share/mysql/test  \
    -DINSTALL_PLUGINDIR=lib%LIBSUFFIX%/mysql/plugin \
    -DINSTALL_SQLBENCHDIR=share \
    -DINSTALL_SUPPORTFILESDIR=share/mysql \
    -DINSTALL_SYSCONFDIR="/etc/mysql" \
    -DINSTALL_SYSCONF2DIR="/etc/mysql/my.cnf.d" \
    -DINSTALL_SCRIPTDIR=bin \
    -DINSTALL_SBINDIR=sbin \
    -DWITH_LIBARCHIVE=ON \
    -DMYSQL_DATADIR=/var/db/mysql \
    -DMYSQL_UNIX_ADDR=/run/mysqld/mysqld.sock
build      : |
    %make
install    : |
    %make_install
    install -D -m 00644 $pkgfiles/mysql.sysusers $installdir/%libdir%/sysusers.d/mysql.conf
    install -D -m 00644 $pkgfiles/mysql.tmpfiles $installdir/%libdir%/tmpfiles.d/mysql.conf
    install -m 00755 $pkgfiles/mariadb_first_install $installdir/usr/bin/mariadb_first_install
    # Nuke static
    rm -v $installdir/%libdir%/*.a
    # Solus doesn't use selinux or apparmor currently.
    rm -rf $installdir/usr/share/mysql/policy
    # Dopey artifacts we don't support...
    rm -rfv $installdir/etc/mysql/init.d
    rm -v $installdir/usr/sbin/rcmysql
    rm -rfv $installdir/etc/mysql/logrotate.d
    rm -rfv $installdir/usr/data/
    rm -v $installdir/usr/share/mysql/*.server
    # We'll handle integration ourselves.
    rm $installdir/usr/share/mysql/binary-configure

    # Beyond broken right now.
    rm -rv $installdir/%libdir%/libmysqlclient_r.so*
